#!/bin/sh
# CPU stress test boot disk version 2 by Gert Hulselmans
#
# This version is designed from scratch. Only 10 lines of code were taken
# from the CPU stress test boot disk version 1, made by Adrian Stanciu
# <adrian@sadyc.net>.
# See: '/runonce' script
#
#
# This program is free software; you can redistribute it and/or
# modify it under the terms of the GNU General Public License as
# published by the Free Software Foundation; either version 2 of
# the License, or (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program; if not, write to the Free Software
# Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
#
#
# Written by Gert Hulselmans and Explorer.
# Last updated on 1 April 2013.


export PATH='/sbin:/bin:/usr/bin:/usr/local/bin'

#set-up kernel file systems and mdev
mount -n -t tmpfs -o size=64k,mode=0755 tmpfs /dev
mkdir /dev/pts
mount -n -t devpts devpts /dev/pts
mount -n -t proc proc /proc
mount -n -t sysfs sysfs /sys
echo /sbin/mdev > /proc/sys/kernel/hotplug
mdev -s

# Load drivers for USB controller, because mdev do not load them automatically.
# Required only by PMagic kernel.
modprobe ehci_hcd
modprobe uhci-hcd
modprobe ohci-hcd
modprobe xhci-hcd

# Modprobe modules from the boot command-line
for i in $modprobe; do
    modprobe $i
done

# Create tmpfs on /tmp for mprime
MEMORY=`awk '/^MemTotal/ {print $2}' /proc/meminfo`
if [ "$MEMORY" -lt "100000" ]; then
    mount -n -t tmpfs -o size=12m,mode=0755 tmpfs /tmp
else
    mount -n -t tmpfs -o size=`expr $MEMORY / 8`k,mode=0755 tmpfs /tmp
fi
